---
import Layout from '@/layouts/Layout.astro';
import { siteConfig } from '@/site.config';

const { url } = Astro;
const searchParams = new URLSearchParams(url.search);
const filterType = searchParams.get('type') || 'all';
const filterValue = searchParams.get('value') || '';
const searchQuery = searchParams.get('q') || '';
const page = parseInt(searchParams.get('page') || '1');

// Website content data - includes pages, blog posts, projects, and resources
const allContent = [
  // Blog Posts
  {
    id: 1,
    title: "Getting Started with Astro",
    excerpt: "Learn the fundamentals of building static sites with Astro framework and modern web technologies.",
    slug: "getting-started-with-astro",
    url: "/blog/getting-started-with-astro",
    publishedAt: "2024-01-15",
    category: "blog",
    tags: ["Astro", "Static Sites", "JavaScript", "Tutorial"],
    author: "John Doe",
    readTime: "5 min read",
    type: "blog"
  },
  {
    id: 2,
    title: "Advanced TypeScript Patterns",
    excerpt: "Explore advanced TypeScript patterns and techniques for building robust applications.",
    slug: "advanced-typescript-patterns",
    url: "/blog/advanced-typescript-patterns",
    publishedAt: "2024-01-10",
    category: "blog",
    tags: ["TypeScript", "Patterns", "JavaScript", "Advanced"],
    author: "Jane Smith",
    readTime: "8 min read",
    type: "blog"
  },
  {
    id: 3,
    title: "Modern CSS Grid Layouts",
    excerpt: "Master CSS Grid to create complex, responsive layouts with ease and flexibility.",
    slug: "modern-css-grid-layouts",
    url: "/blog/modern-css-grid-layouts",
    publishedAt: "2024-01-05",
    category: "blog",
    tags: ["CSS", "Grid", "Layouts", "Responsive"],
    author: "Mike Johnson",
    readTime: "6 min read",
    type: "blog"
  },

  // Pages
  {
    id: 10,
    title: "About Our Company",
    excerpt: "Learn about our mission, values, and the team behind our success.",
    slug: "about",
    url: "/about",
    publishedAt: "2024-01-01",
    category: "pages",
    tags: ["about", "company", "mission", "team", "values"],
    author: "Company",
    readTime: "3 min read",
    type: "page"
  },
  {
    id: 11,
    title: "Our Services",
    excerpt: "Comprehensive overview of the services we offer to help your business grow.",
    slug: "services",
    url: "/services",
    publishedAt: "2024-01-01",
    category: "pages",
    tags: ["services", "business", "solutions", "consulting"],
    author: "Company",
    readTime: "4 min read",
    type: "page"
  },
  {
    id: 12,
    title: "Contact Information",
    excerpt: "Get in touch with us. Find our contact details and office locations.",
    slug: "contact",
    url: "/contact",
    publishedAt: "2024-01-01",
    category: "pages",
    tags: ["contact", "information", "office", "phone", "email"],
    author: "Company",
    readTime: "2 min read",
    type: "page"
  },
  {
    id: 13,
    title: "Portfolio Showcase",
    excerpt: "Explore our best work and successful project case studies.",
    slug: "portfolio",
    url: "/portfolio",
    publishedAt: "2024-01-01",
    category: "pages",
    tags: ["portfolio", "showcase", "projects", "case studies", "work"],
    author: "Company",
    readTime: "5 min read",
    type: "page"
  },

  // Projects
  {
    id: 20,
    title: "E-commerce Platform Development",
    excerpt: "Modern, scalable e-commerce solution built with cutting-edge technology.",
    slug: "ecommerce-platform",
    url: "/projects/ecommerce-platform",
    publishedAt: "2024-01-01",
    category: "projects",
    tags: ["ecommerce", "platform", "scalable", "technology", "development"],
    author: "Development Team",
    readTime: "6 min read",
    type: "project"
  },
  {
    id: 21,
    title: "Mobile App Development",
    excerpt: "Cross-platform mobile application with seamless user experience.",
    slug: "mobile-app",
    url: "/projects/mobile-app",
    publishedAt: "2024-01-01",
    category: "projects",
    tags: ["mobile", "app", "development", "cross platform", "UX"],
    author: "Development Team",
    readTime: "7 min read",
    type: "project"
  },
  {
    id: 22,
    title: "Brand Identity Redesign",
    excerpt: "Complete brand overhaul including logo, guidelines, and marketing materials.",
    slug: "brand-redesign",
    url: "/projects/brand-redesign",
    publishedAt: "2024-01-01",
    category: "projects",
    tags: ["brand", "identity", "redesign", "logo", "marketing"],
    author: "Design Team",
    readTime: "5 min read",
    type: "project"
  },

  // Resources
  {
    id: 30,
    title: "Free Design Templates",
    excerpt: "Collection of high-quality design templates for various business needs.",
    slug: "design-templates",
    url: "/resources/design-templates",
    publishedAt: "2024-01-01",
    category: "resources",
    tags: ["templates", "design", "business", "free", "downloads"],
    author: "Design Team",
    readTime: "3 min read",
    type: "resource"
  },
  {
    id: 31,
    title: "Business Planning Toolkit",
    excerpt: "Comprehensive toolkit with templates and guides for business planning.",
    slug: "business-toolkit",
    url: "/resources/business-toolkit",
    publishedAt: "2024-01-01",
    category: "resources",
    tags: ["business", "planning", "toolkit", "templates", "guides"],
    author: "Business Team",
    readTime: "8 min read",
    type: "resource"
  },
  {
    id: 32,
    title: "SEO Guide for Beginners",
    excerpt: "Everything you need to know to get started with search engine optimization.",
    slug: "seo-guide",
    url: "/resources/seo-guide",
    publishedAt: "2024-01-01",
    category: "resources",
    tags: ["SEO", "guide", "beginners", "optimization", "search"],
    author: "Marketing Team",
    readTime: "10 min read",
    type: "resource"
  }
];

// Filter content based on the filter type, value, and search query
let filteredContent = allContent;
let pageTitle = "All Content";
let displayTitle = "All Content";

// Apply search query filter first if present
if (searchQuery) {
  filteredContent = filteredContent.filter(item =>
    item.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
    item.excerpt.toLowerCase().includes(searchQuery.toLowerCase()) ||
    item.category.toLowerCase().includes(searchQuery.toLowerCase()) ||
    item.tags.some(tag => tag.toLowerCase().includes(searchQuery.toLowerCase()))
  );
  pageTitle = "Search Results";
  displayTitle = `Search results for "${searchQuery}"`;
}

// Apply additional filters if search query is not the primary filter
if (filterType === 'category' && filterValue && !searchQuery) {
  filteredContent = allContent.filter(item =>
    item.category.toLowerCase() === filterValue.toLowerCase()
  );
  pageTitle = "Search Results";
  displayTitle = `Content in "${filterValue}"`;
} else if (filterType === 'tag' && filterValue && !searchQuery) {
  filteredContent = allContent.filter(item =>
    item.tags.some(tag => tag.toLowerCase() === filterValue.toLowerCase())
  );
  pageTitle = "Search Results";
  displayTitle = `Content tagged with "${filterValue}"`;
} else if (filterType === 'archive' && filterValue && !searchQuery) {
  const [year, month] = filterValue.split('-');
  filteredContent = allContent.filter(item => {
    const itemDate = new Date(item.publishedAt);
    const itemYear = itemDate.getFullYear().toString();
    const itemMonth = (itemDate.getMonth() + 1).toString().padStart(2, '0');
    return itemYear === year && (!month || itemMonth === month);
  });

  pageTitle = "Search Results";
  if (month) {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'];
    displayTitle = `Content from ${monthNames[parseInt(month) - 1]} ${year}`;
  } else {
    displayTitle = `Content from ${year}`;
  }
} else if (!searchQuery && !filterType) {
  pageTitle = "Search";
  displayTitle = "All Content";
}


// Format date function
function formatDate(dateString: string): string {
  const options: Intl.DateTimeFormatOptions = {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  };
  return new Date(dateString).toLocaleDateString('en-US', options);
}
---

<Layout
  title={`${pageTitle} | ${siteConfig.brand.name}`}
  description={`Browse ${pageTitle.toLowerCase()} on ${siteConfig.brand.name}`}
>
  <main class="page-content">
    <!-- Page Header with Red Background - Simple Title Only -->
    <section class="page-header">
      <div class="page-header-content">
        <h1>{pageTitle}</h1>
      </div>

      <!-- Simple top-right pill navigation -->
      <div class="page-nav-pills">
        <button class="pill-button" data-filter="categories" aria-label="Search Categories">
          <span class="pill-text">Categories</span>
        </button>
        <button class="pill-button" data-filter="keywords" aria-label="Keywords">
          <span class="pill-text">Keywords</span>
        </button>
        <button class="pill-button" data-filter="featured" aria-label="Featured">
          <span class="pill-text">Featured</span>
        </button>
      </div>

      <!-- Slide-out card that follows the button -->
      <div class="slide-out-card" id="slideOutCard">
        <div class="card-content" id="cardContent">
          <!-- Content will be loaded here based on selected filter -->
        </div>
      </div>
    </section>

    <!-- Dropdown Content Area for results tabs -->
    <section class="results-dropdown-content" id="resultsDropdownContent">
      <div class="dropdown-content-wrapper"></div>
    </section>

    <!-- Mobile Collapsible Content Area -->
    <section class="mobile-collapsible-content" id="mobileCollapsibleContent">
      <!-- Search In Widget -->
      <div class="mobile-section" id="mobileSearchInSection" style="display: none;">
        <div class="mobile-section-content">
          <h3>Search in:</h3>
          <div class="category-buttons">
            <button class="category-btn active" data-category="all">All<br>Website</button>
            <button class="category-btn" data-category="pages">Pages</button>
            <button class="category-btn" data-category="blog">Blog</button>
            <button class="category-btn" data-category="projects">Projects</button>
            <button class="category-btn" data-category="resources">Resources</button>
          </div>
        </div>
      </div>

      <!-- Keywords Widget -->
      <div class="mobile-section" id="mobileKeywordsSection" style="display: none;">
        <div class="mobile-section-content">
          <h3>Popular keywords:</h3>
          <div class="keyword-tags">
            <button class="keyword-tag" data-keyword="about">about</button>
            <button class="keyword-tag" data-keyword="services">services</button>
            <button class="keyword-tag" data-keyword="portfolio">portfolio</button>
            <button class="keyword-tag" data-keyword="contact">contact</button>
            <button class="keyword-tag" data-keyword="projects">projects</button>
            <button class="keyword-tag" data-keyword="experience">experience</button>
            <button class="keyword-tag" data-keyword="skills">skills</button>
            <button class="keyword-tag" data-keyword="testimonials">testimonials</button>
            <button class="keyword-tag" data-keyword="blog">blog</button>
            <button class="keyword-tag" data-keyword="resources">resources</button>
          </div>
        </div>
      </div>

      <!-- Featured Widget -->
      <div class="mobile-section" id="mobileFeaturedSection" style="display: none;">
        <div class="mobile-section-content">
          <h3>Featured Content</h3>
          <div class="featured-cards">
            <a href="/about" class="featured-card">
              <div class="featured-content">
                <h4>About Our Company</h4>
                <span class="featured-meta">Most Popular</span>
              </div>
            </a>
            <a href="/contact" class="featured-card">
              <div class="featured-content">
                <h4>Get In Touch</h4>
                <span class="featured-meta">Recommended</span>
              </div>
            </a>
            <a href="/services" class="featured-card">
              <div class="featured-content">
                <h4>Our Services</h4>
                <span class="featured-meta">Trending</span>
              </div>
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Title and Navigation Section -->
    <section class="title-nav-section">
      <div class="main-content-wrapper content-aligned">
        <div class="title-nav-wrapper">
          <!-- Left side: Title and Breadcrumb -->
          <div class="title-breadcrumb">
            <h2 class="display-title">{displayTitle}</h2>
            <nav class="breadcrumb">
              <a href="/" class="breadcrumb-link">Home</a>
              <span class="breadcrumb-separator">›</span>
              <a href="/insights" class="breadcrumb-link">Insights</a>
              <span class="breadcrumb-separator">›</span>
              <span class="breadcrumb-current">Results</span>
            </nav>
          </div>

          <!-- Right side: Search Bar -->
          <div class="search-container">
            <form class="search-form" method="get">
              <div class="search-input-wrapper">
                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M21 21L15.5 15.5M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <input
                  type="text"
                  name="q"
                  value={searchQuery}
                  placeholder="Search"
                  class="search-input"
                  aria-label="Search insights"
                />
                <button type="submit" class="search-submit" aria-label="Search">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
              {filterType && filterType !== 'all' && !searchQuery && (
                <input type="hidden" name="type" value={filterType} />
              )}
              {filterValue && !searchQuery && (
                <input type="hidden" name="value" value={filterValue} />
              )}
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- Content Section - widgets for dropdown functionality only -->
    <section class="content-section">
      <div class="container content-aligned">
        <!-- Always show content sections for dropdown functionality -->
        <div class="content-sections" style="display: none;">
            <!-- Search Categories -->
            <div class="content-section widget" id="searchInWidget" style="display: none;">
              <div class="category-buttons">
                <button class="category-btn active" data-category="all">All<br>Website</button>
                <button class="category-btn" data-category="pages">Pages</button>
                <button class="category-btn" data-category="blog">Blog</button>
                <button class="category-btn" data-category="projects">Projects</button>
                <button class="category-btn" data-category="resources">Resources</button>
              </div>
            </div>

            <!-- Popular Keywords -->
            <div class="content-section widget" id="keywordsWidget" style="display: none;">
              <div class="keyword-tags">
                <button class="keyword-tag" data-keyword="about">about</button>
                <button class="keyword-tag" data-keyword="services">services</button>
                <button class="keyword-tag" data-keyword="portfolio">portfolio</button>
                <button class="keyword-tag" data-keyword="contact">contact</button>
                <button class="keyword-tag" data-keyword="projects">projects</button>
                <button class="keyword-tag" data-keyword="experience">experience</button>
                <button class="keyword-tag" data-keyword="skills">skills</button>
                <button class="keyword-tag" data-keyword="testimonials">testimonials</button>
                <button class="keyword-tag" data-keyword="blog">blog</button>
                <button class="keyword-tag" data-keyword="resources">resources</button>
              </div>
            </div>

            <!-- Default Content -->
            <div class="content-section">
              <div class="default-content">
                <p>Use the tabs above to explore different ways to find content, discover popular keywords, or browse our featured selections. You can also use the search bar to find specific information across our website.</p>
                <p>Start by clicking on one of the navigation tabs above to see available options, or enter a search term in the search box.</p>
              </div>
            </div>


            <!-- Featured Posts (Combined Suggested & Popular) -->
            <div class="content-section widget" id="featuredWidget" style="display: none;">
              <div class="featured-cards">
                <a href="/about" class="featured-card">
                  <div class="featured-content">
                    <h4>About Our Company</h4>
                    <span class="featured-meta">Most Popular</span>
                  </div>
                </a>
                <a href="/contact" class="featured-card">
                  <div class="featured-content">
                    <h4>Get In Touch</h4>
                    <span class="featured-meta">Recommended</span>
                  </div>
                </a>
                <a href="/services" class="featured-card">
                  <div class="featured-content">
                    <h4>Our Services</h4>
                    <span class="featured-meta">Trending</span>
                  </div>
                </a>
                <a href="/portfolio" class="featured-card">
                  <div class="featured-content">
                    <h4>Portfolio</h4>
                    <span class="featured-meta">Showcase</span>
                  </div>
                </a>
                <a href="/team" class="featured-card">
                  <div class="featured-content">
                    <h4>Our Team</h4>
                    <span class="featured-meta">Meet Us</span>
                  </div>
                </a>
                <a href="/resources" class="featured-card">
                  <div class="featured-content">
                    <h4>Resources</h4>
                    <span class="featured-meta">Free Tools</span>
                  </div>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Results Section - Direct to page level, not in containers -->
    <div class="main-content-wrapper content-aligned" style="padding-top: 0.25rem;">
      {filteredContent.length > 0 ? (
        <div class="entries">
          {filteredContent.map((item) => (
            <article class="entry-card" itemscope itemtype="https://schema.org/BlogPosting">
              <div class="card-header">
                <div class="meta-categories">
                  <a href={`/results?type=category&value=${encodeURIComponent(item.category)}`} class="category-pill" itemprop="about">
                    {item.category}
                  </a>
                </div>
                <div class="meta-date">
                  <time datetime={item.publishedAt} itemprop="datePublished">
                    {formatDate(item.publishedAt)}
                  </time>
                </div>
              </div>

              <h2 class="entry-title" itemprop="headline">
                <a href={item.url} itemprop="url">{item.title}</a>
              </h2>

              <p class="entry-excerpt" itemprop="description">
                {item.excerpt}
              </p>

              <div class="card-footer">
                <div class="meta-tags">
                  <div class="tags-container">
                    {item.tags.map((tag) => (
                      <a href={`/results?type=tag&value=${encodeURIComponent(tag)}`} class="tag-pill" itemprop="keywords">
                        {tag}
                      </a>
                    ))}
                  </div>
                </div>
              </div>
            </article>
          ))}
        </div>
      ) : (
        <div class="no-results">
          <h2>No results found</h2>
          <p>Sorry, we couldn't find any results matching your criteria.</p>
          <button onclick="history.back()" class="back-link">← Back</button>
        </div>
      )}
    </div>
  </main>
</Layout>

<script>
  // Category button functionality and results header tabs
  document.addEventListener('DOMContentLoaded', () => {
    const categoryBtns = document.querySelectorAll('.category-btn');
    const keywordTags = document.querySelectorAll('.keyword-tag');
    const searchInput = document.querySelector('.search-input');
    const searchForm = document.querySelector('.search-form');

    // Tabs
    const navTabs = document.querySelectorAll('.results-nav-tab');
    const dropdown = document.getElementById('resultsDropdownContent');
    const dropdownWrapper = dropdown ? dropdown.querySelector('.dropdown-content-wrapper') : null;
    const pageHeader = document.querySelector('.page-header');
    const tabsRow = document.querySelector('.results-nav-tabs');

    // Widgets
    const searchInWidget = document.getElementById('searchInWidget');
    const keywordsWidget = document.getElementById('keywordsWidget');
    const featuredWidget = document.getElementById('featuredWidget');


    // Position overlay under header
    function positionOverlay() {
      if (!dropdown || !pageHeader) return;
      const rect = pageHeader.getBoundingClientRect();
      dropdown.style.setProperty('--dropdown-top', `${rect.bottom}px`);
    }

    // Move real tab into overlay and restore
    const tabHomes = new WeakMap();
    let currentAttachedTab = null;

    function attachRealTab(tabEl: Element | null) {
      if (!dropdown || !tabEl) return;
      const tab = tabEl as HTMLElement;
      if (currentAttachedTab === tab) return;

      // Calculate and store the correct position BEFORE any layout changes
      const rect = tab.getBoundingClientRect();
      const ddRect = dropdown.getBoundingClientRect();
      const correctLeft = rect.left - ddRect.left + rect.width / 2;

      const phW = Math.round(rect.width);
      const phH = Math.round(rect.height);
      const placeholder = document.createElement('span');
      placeholder.className = 'tab-placeholder';
      placeholder.style.display = 'inline-flex';
      placeholder.style.width = `${phW}px`;
      placeholder.style.height = `${phH}px`;
      placeholder.style.flex = `0 0 ${phW}px`;

      const parent = tab.parentNode as Node;
      const nextSibling = tab.nextSibling as ChildNode | null;
      tabHomes.set(tab, { parent, nextSibling, placeholder, widthPx: phW, correctLeft });

      // NOW restore the previous tab (this changes layout)
      if (currentAttachedTab && currentAttachedTab !== tab) {
        restoreRealTab(currentAttachedTab);
      }

      // Insert placeholder and attach new tab
      parent.insertBefore(placeholder, tab);
      dropdown.appendChild(tab);
      tab.classList.add('attached-tab');
      tab.style.pointerEvents = 'auto';
      tab.style.width = `${phW}px`;
      tab.style.flex = `0 0 ${phW}px`;

      updateAttachedTabPosition(tab);
      currentAttachedTab = tab;
    }

    function updateAttachedTabPosition(tabEl) {
      const tab = tabEl || currentAttachedTab;
      if (!dropdown || !tab) return;
      const home = tabHomes.get(tab);
      if (!home) return;
      try {
        const ddRect = dropdown.getBoundingClientRect();

        // Use the stored correct position if available
        let rawLeft;
        if (home.correctLeft !== undefined) {
          rawLeft = home.correctLeft;
        } else {
          // Fallback to placeholder position
          const phRect = home.placeholder.getBoundingClientRect();
          rawLeft = phRect.left - ddRect.left + phRect.width / 2;
        }

        const tabWidth = tab.offsetWidth || 100;
        const minLeft = tabWidth / 2;
        const maxLeft = ddRect.width - tabWidth / 2;
        const constrainedLeft = Math.max(minLeft, Math.min(maxLeft, rawLeft));
        const left = Math.round(constrainedLeft * 2) / 2; // snap to 0.5px
        dropdown.style.setProperty('--attached-tab-left', `${left}px`);
      } catch {}
    }

    function restoreRealTab(tabEl) {
      const tab = tabEl || currentAttachedTab;
      if (!tab) return;
      const home = tabHomes.get(tab);
      if (!home) return;
      const prevTransition = tab.style.transition;
      tab.style.transition = 'none';
      tab.classList.remove('attached-tab');
      tab.style.removeProperty('pointer-events');
      const { parent, nextSibling, placeholder, widthPx } = home;
      tab.style.width = `${widthPx}px`;
      tab.style.flex = `0 0 ${widthPx}px`;
      parent.insertBefore(tab, nextSibling);
      requestAnimationFrame(() => {
        placeholder.remove();
        requestAnimationFrame(() => {
          tab.style.removeProperty('width');
          tab.style.removeProperty('flex');
        });
      });
      requestAnimationFrame(() => {
        tab.style.transition = prevTransition || '';
      });
      tabHomes.delete(tab);
      if (currentAttachedTab === tab) currentAttachedTab = null;
    }

    // Toggle
    let isClosing = false;
    function closeOverlay() {
      if (!dropdown || !dropdown.classList.contains('open') || isClosing) return;
      isClosing = true;
      updateAttachedTabPosition();
      positionOverlay();
      dropdown.classList.add('closing');
      const finalize = () => {
        if (currentAttachedTab) restoreRealTab(currentAttachedTab);
        navTabs.forEach(t => t.classList.remove('active'));
        isClosing = false;
        dropdown.classList.remove('closing');
        dropdown.classList.remove('open');
      };
      const onDone = (ev) => {
        if (ev.target !== dropdown) return;
        if (ev.propertyName !== 'transform') return;
        dropdown.removeEventListener('transitionend', onDone);
        clearTimeout(fallback);
        finalize();
      };
      dropdown.addEventListener('transitionend', onDone);
      const fallback = setTimeout(finalize, 1200);
    }

    function toggleDropdown(widgetType) {
      if (!dropdown) return;
      const clickedTab = document.querySelector(`[data-tab="${widgetType}"]`);
      const isOpen = dropdown.classList.contains('open');
      const isSame = clickedTab ? clickedTab.classList.contains('active') : false;

      if (isOpen && isSame) {
        closeOverlay();
        return;
      }

      navTabs.forEach(t => t.classList.remove('active'));
      if (clickedTab) clickedTab.classList.add('active');

      // Content
      if (dropdownWrapper) {
        dropdownWrapper.innerHTML = '';
        let widget: Element | null = null;
        if (widgetType === 'searchin') widget = searchInWidget;
        if (widgetType === 'keywords') widget = keywordsWidget;
        if (widgetType === 'featured') widget = featuredWidget;


        if (widget) {
          dropdownWrapper.appendChild(widget.cloneNode(true));
          const widgetElement = dropdownWrapper.querySelector('.widget');
          if (widgetElement) widgetElement.style.display = 'block';
        }
      }

      positionOverlay();
      attachRealTab(clickedTab);
      dropdown.classList.add('open');
    }

    // Tab click
    navTabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        const t = tab.getAttribute('data-tab');
        if (t) toggleDropdown(t);
      });
    });


    // Positioning updates
    // Add resize handler to unlock tabs row on mobile and auto-close dropdowns
    let wasDesktop = window.innerWidth > 480;
    window.addEventListener('resize', () => {
      positionOverlay();
      if (!isClosing) updateAttachedTabPosition();

      const isNowMobile = window.innerWidth <= 480;
      const isNowDesktop = window.innerWidth > 480;

